<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Available Station</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">

    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4285F4',
                        secondary: '#34A853',
                    }
                }
            }
        }
    </script>

    
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }

            .card {
                @apply bg-white rounded-lg border border-gray-200 overflow-hidden;
            }

            .card-hover {
                @apply hover:shadow-md hover:-translate-y-1 transition-all duration-200;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 md:p-6">
<div class="max-w-5xl mx-auto">
    
    <header class="mb-6">
        <h1 class="text-2xl md:text-3xl font-bold text-gray-800 flex items-center">
            <i class="fa fa-plug text-primary mr-2"></i>Search for available stations
        </h1>
    </header>

    
    <div class="mb-8">
        <div class="flex flex-col sm:flex-row gap-3">
            <input
                    type="text"
                    id="addressInput"
                    placeholder="Input station address to get the next available station"
                    class="flex-1 px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
            >
            <button id="searchBtn"
                    class="bg-primary text-white px-6 py-3 rounded-lg font-medium hover:bg-primary/90 transition-colors flex items-center justify-center">
                <i class="fa fa-search mr-2"></i>search
            </button>
        </div>
    </div>

    
    <div id="resultTitle" class="text-lg font-semibold text-gray-800 mb-4">
        available stations list
    </div>

    
    <ul id="portList" class="space-y-4">
        
    </ul>
</div>

<script src="base.js"></script>
<script>
    async function loadApiKey() {
        try {
            const response = await fetch(thirdpartapibaseurl + 'api/google_map/apikey',);
            const {google_maps_api_key} = await response.json();
            
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${google_maps_api_key}`;
            script.async = true;
            script.defer = true;
            
            script.onerror = () => console.error("Google Maps SDK load error");
            document.head.appendChild(script);
        } catch (err) {
            console.error("rise error when get apikey", err);
        }
    }

    
    let allPorts = [];
    const portListEl = document.getElementById('portList');
    const resultTitleEl = document.getElementById('resultTitle');
    const addressInput = document.getElementById('addressInput');
    const searchBtn = document.getElementById('searchBtn');

    
    window.onload = async () => {
        await loadApiKey();
        await fetchAllPorts();
        renderPorts(allPorts, false);

        
        searchBtn.addEventListener('click', searchNearby);
        addressInput.addEventListener('keyup', (e) => e.key === 'Enter' && searchNearby());
    };

    async function fetchAllPorts() {
        try {
            showLoading();
            const response = await fetch(backendbaseurl+'/api/charging/stations/?charger_status=idle',);
            const data = await response.json();
            allPorts = data.results || [];
        } catch (error) {
            portListEl.innerHTML = `
          <li class="card p-6 text-center">
            <i class="fa fa-exclamation-circle text-red-500 text-2xl mb-2"></i>
            <p class="text-gray-600">error when loading data, refresh page please</p>
          </li>
        `;
        } finally {
            hideLoading();
        }
    }


    async function searchNearby() {
        const address = addressInput.value.trim();
        if (!address) {
            alert('input address please');
            return;
        }

        try {
            showLoading();
            const {lat, lng} = await addressToLatLng(address);
            if (!lat || !lng) {
                alert('error address');
                return;
            }

            
            const portsWithDistance = allPorts.map(port => ({
                ...port,
                distance: calculateDistance(lat, lng, port.latitude, port.longitude)
            })).filter(port => port.distance !== null)
                .sort((a, b) => a.distance - b.distance);

            renderPorts(portsWithDistance, true);
        } catch (error) {
            portListEl.innerHTML = `
          <li class="card p-6 text-center">
            <i class="fa fa-exclamation-circle text-red-500 text-2xl mb-2"></i>
            <p class="text-gray-600">failed, retry please</p>
          </li>
        `;
        } finally {
            hideLoading();
        }
    }
    function renderPorts(stations, isSearchResult) {
        if (stations.length === 0) {
            portListEl.innerHTML = `
          <li class="card p-8 text-center">
            <i class="fa fa-map-marker text-gray-300 text-4xl mb-3"></i>
            <p class="text-gray-700 font-medium">no available station</p>
            <p class="text-gray-500 text-sm mt-1">try other address please</p>
          </li>
        `;
            resultTitleEl.textContent = isSearchResult ? 'no available station' : 'available stations list';
            return;
        }

        resultTitleEl.textContent = isSearchResult
            ? `available stations in total:${stations.length}`
            : `available stations in total:${stations.length}`;

        portListEl.innerHTML = stations.map(station => `
        <li class="card card-hover">
          <div class="p-4">
            <a href="${apigatewaybaseurl}stationDetail.html?station_id=${station.id}" class="block">
              <div class="font-semibold text-gray-800 text-lg mb-2 flex items-center">
                <i class="fa fa-bolt text-yellow-500 mr-2"></i>
                ${station.name}
              </div>
            </a>

            <div class="text-gray-600 text-sm mb-3 flex items-center">
              <i class="fa fa-map-marker text-primary mr-2"></i>
              ${station.address}
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-2 text-sm text-gray-600">
              <div><i class="fa fa-plug text-gray-400 mr-1"></i>charger type:${station.chargers_type}</div>
              <div><i class="fa fa-clock-o text-gray-400 mr-1"></i>update at:${station.updated_at}</div>
              <div><i class="fa fa-check-circle text-secondary mr-1"></i>available chargers in total:${station.avaliable_count}</div>

              ${isSearchResult ? `
                <div class="md:col-span-3 mt-2 text-primary font-medium">
                  <i class="fa fa-road mr-1"></i>distance:${station.distance.toFixed(1)}km
                </div>
              ` : ''}
            </div>
          </div>
        </li>
      `).join('');
    }

    function addressToLatLng(address) {
        return new Promise((resolve, reject) => {
            const geocoder = new google.maps.Geocoder();
            geocoder.geocode({address}, (results, status) => {
                if (status === google.maps.GeocoderStatus.OK && results.length) {
                    const loc = results[0].geometry.location;
                    resolve({lat: loc.lat(), lng: loc.lng()});
                } else {
                    reject('failed, retry please');
                }
            });
        });
    }

    function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371;
        const dLat = toRadians(lat2 - lat1);
        const dLon = toRadians(lon2 - lon1);
        const a =
            Math.sin(dLat / 2) * Math.sin(dLat / 2) +
            Math.cos(toRadians(lat1)) * Math.cos(toRadians(lat2)) *
            Math.sin(dLon / 2) * Math.sin(dLon / 2);
        return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)));
    }

    function toRadians(degrees) {
        return degrees * (Math.PI / 180);
    }

    function showLoading() {
        portListEl.innerHTML = `
        <li class="card p-6 text-center">
          <div class="inline-block animate-spin rounded-full h-8 w-8 border-2 border-primary border-t-transparent mb-2"></div>
          <p class="text-gray-600">loading</p>
        </li>
      `;
    }

    function hideLoading() {
        
    }
</script>
</body>
</html>