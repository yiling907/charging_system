<button id="googlePayButton" class="google-pay-button" onclick="initGooglePay()">
    pay by google
</button>

<div id="paymentResult"></div>

<script>
    // 支付参数配置（核心）
const paymentDataRequest = {
  apiVersion: 2,
  apiVersionMinor: 0,
  merchantInfo: {
    merchantId: "你的商户ID", // 从 Google Pay 控制台获取
    merchantName: "你的商户名称"
  },
  allowedPaymentMethods: [
    {
      type: "CARD",
      parameters: {
        allowedAuthMethods: ["PAN_ONLY", "CRYPTOGRAM_3DS"], // 支持的验证方式
        allowedCardNetworks: ["VISA", "MASTERCARD"] // 支持的卡组织
      },
      tokenizationSpecification: {
        type: "PAYMENT_GATEWAY", // 支付网关模式（或 DIRECT 直接处理）
        parameters: {
          gateway: "你的支付网关名称", // 如 stripe、paypal 等
          gatewayMerchantId: "网关商户ID" // 支付网关提供的商户ID
        }
      }
    }
  ],
  transactionInfo: {
    totalPriceStatus: "FINAL", // 价格是否最终确定
    totalPriceLabel: "总价",
    totalPrice: "10.00", // 支付金额（字符串类型）
    currencyCode: "CNY", // 货币代码（如 USD、CNY）
    countryCode: "CN" // 国家代码
  }
};

// 检查设备是否支持 Google Pay
let paymentsClient;
function initGooglePay() {
  if (!paymentsClient) {
    paymentsClient = new google.payments.api.PaymentsClient({
      environment: "TEST" // 测试环境，生产环境用 "PRODUCTION"
    });
  }

  // 检查是否支持 Google Pay
  paymentsClient.isReadyToPay({ allowedPaymentMethods: paymentDataRequest.allowedPaymentMethods })
    .then(response => {
      if (response.result) {
        // 支持则发起支付
        requestPayment();
      } else {
        alert("该设备不支持 Google Pay");
      }
    })
    .catch(error => {
      console.error("Google Pay 初始化失败:", error);
    });
}

// 发起支付请求
function requestPayment() {
  paymentsClient.loadPaymentData(paymentDataRequest)
    .then(paymentData => {
      // 支付信息获取成功，发送到后端验证
      handlePaymentSuccess(paymentData);
    })
    .catch(error => {
      console.error("支付失败:", error);
      document.getElementById("paymentResult").textContent = "支付失败，请重试";
    });
}

// 处理支付成功的回调
function handlePaymentSuccess(paymentData) {
  // paymentData 包含加密的支付信息（如卡号令牌）
  const paymentToken = paymentData.paymentMethodData.tokenizationData.token;

  // 发送令牌到后端验证
  fetch("/api/verify-google-pay", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      token: paymentToken,
      amount: "10.00", // 金额需与前端一致，防止篡改
      orderId: "ORDER_12345" // 订单ID
    })
  })
  .then(response => response.json())
  .then(result => {
    if (result.success) {
      document.getElementById("paymentResult").textContent = "支付成功！";
      // 跳转到订单成功页
    } else {
      document.getElementById("paymentResult").textContent = "支付验证失败: " + result.message;
    }
  })
  .catch(error => {
    console.error("后端验证失败:", error);
  });
}
</script>